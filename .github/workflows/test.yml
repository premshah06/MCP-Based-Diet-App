name: Diet Coach MCP Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11, 3.12]
        component: [api, mcp]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.component }}-${{ hashFiles('apps/*/requirements.txt', 'apps/*/test_requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.component }}-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python test_runner.py --install-deps --component ${{ matrix.component }}

    - name: Run linting
      run: |
        python test_runner.py --lint --component ${{ matrix.component }}

    - name: Run tests with coverage
      run: |
        python test_runner.py --coverage --component ${{ matrix.component }}

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.11'
      with:
        file: apps/diet-${{ matrix.component }}/coverage.xml
        flags: ${{ matrix.component }}
        name: diet-coach-${{ matrix.component }}

  integration-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python test_runner.py --install-deps --component all

    - name: Build Docker images
      run: |
        make build

    - name: Start services
      run: |
        make up

    - name: Wait for services to be healthy
      run: |
        timeout 120 bash -c 'until curl -f http://localhost:8000/health; do sleep 5; done'

    - name: Run integration tests
      run: |
        # Test API endpoints
        curl -f http://localhost:8000/health
        
        # Test TDEE calculation
        curl -X POST "http://localhost:8000/tdee" \
          -H "Content-Type: application/json" \
          -d '{"sex":"male","age":30,"height_cm":175,"weight_kg":70,"activity_level":"moderate","goal":"cut"}'
        
        # Test meal plan generation
        curl -X POST "http://localhost:8000/mealplan" \
          -H "Content-Type: application/json" \
          -d '{"calories":2000,"protein_g":150,"fat_g":67,"carbs_g":200,"diet_tags":["veg"],"days":1}'

    - name: Check service health
      run: |
        make health

    - name: Show logs on failure
      if: failure()
      run: |
        make logs

    - name: Cleanup
      if: always()
      run: |
        make down
